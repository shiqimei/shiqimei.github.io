<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fixing Boot Issues: A Deep Dive into MBR, PBR, and BCD - Shiqi Mei</title>
  <link rel="icon" type="image/png" href="../avatar.png">
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <div class="container">
    <a href="/" class="back-link">&larr; back</a>

    <article>
      <header class="post-header">
        <div class="post-header-row">
          <h1 class="post-title">Fixing Boot Issues: A Deep Dive into MBR, PBR, and BCD</h1>
          <div class="lang-toggle" id="langToggle">
            <button data-lang="en" class="active">EN</button>
            <button data-lang="zh">CN</button>
          </div>
        </div>
        <p class="post-meta">Feb 21, 2018</p>
      </header>

      <div class="post-content">
        <div class="lang-en">
<p>I was recently dual-booting Windows 10 and Linux. When I decided to remove Linux, I simply formatted the Linux partition from Windows PE. Bad idea. After reboot, I was greeted with <code>grub rescue&gt;</code>. Time to learn how boot systems actually work.</p>
<h2>The Problem</h2>
<p>When you install Linux alongside Windows, GRUB (the Linux bootloader) takes over the MBR. GRUB stores part of itself in the MBR and its configuration files in the Linux partition at <code>/boot/grub/</code>. When you delete the Linux partition, you&#39;re deleting GRUB&#39;s configuration files, but GRUB is still in the MBR trying to load them.</p>
<h2>Understanding the Boot Process</h2>
<h3>Key Concepts</h3>
<p><strong>MBR (Master Boot Record)</strong></p>
<p>The first 512 bytes of a hard disk, containing:</p>
<ul>
<li><strong>Boot Loader</strong> (446 bytes): Initial boot code</li>
<li><strong>DPT - Disk Partition Table</strong> (64 bytes): Partition information (max 4 primary partitions)</li>
<li><strong>Magic Number</strong> (2 bytes): Boot signature <code>55 AA</code></li>
</ul>
<p><strong>PBR (Partition Boot Record)</strong></p>
<p>Located at the start of each bootable partition. Contains code to load the OS bootloader (like <code>bootmgr</code> for Windows).</p>
<p><strong>BCD (Boot Configuration Data)</strong></p>
<p>Windows boot configuration file, replacing the old <code>boot.ini</code>. Located at <code>\boot\bcd</code> on the system partition.</p>
<h3>Windows Boot Sequence</h3>
<pre><code class="language-text">BIOS → MBR → PBR → bootmgr → BCD → winload.exe → Windows Kernel</code></pre><h3>Linux Boot Sequence</h3>
<pre><code class="language-text">BIOS → MBR (GRUB Stage 1) → PBR → GRUB Stage 2 → grub.cfg → Linux Kernel</code></pre><h3>How GRUB Boots Windows</h3>
<p>When dual-booting, GRUB chainloads Windows by handing control to <code>bootmgr</code>:</p>
<pre><code class="language-text">BIOS → MBR (GRUB) → PBR → bootmgr → BCD → Windows</code></pre><h2>Attempting Recovery from grub rescue</h2>
<p>First, I tried recovering from the <code>grub rescue&gt;</code> prompt:</p>
<pre><code class="language-bash"># List all partitions
ls
# Output: (hd0)(hd0,msdos1)(hd1)(hd1,msdos3)(hd1,msdos2)(hd1,msdos1)

# Find the partition with GRUB files
ls (hd0,msdos1)/boot/grub
ls (hd1,msdos1)/boot/grub
# Looking for a partition that doesn&#039;t return &quot;error:unknown filesystem&quot;

# If found, set root and boot
set root=(hd1,msdos1)/boot/grub
set prefix=(hd1,msdos1)/boot/grub
insmod normal
normal</code></pre><p>This didn&#39;t work for me - all partitions returned <code>error:unknown filesystem</code> because the Linux partition was gone.</p>
<h2>The Solution: Rebuild the Boot Chain</h2>
<p>I booted into Windows PE and used these tools (commonly included in PE environments):</p>
<ul>
<li><strong>DiskGenius</strong>: Rebuild MBR</li>
<li><strong>BCDrepair</strong>: Fix BCD files</li>
<li><strong>Bootice</strong>: Rebuild MBR, PBR, edit BCD</li>
<li><strong>NTBoot</strong>: Automatic boot repair</li>
</ul>
<h3>Step 1: Rewrite MBR with Bootice</h3>
<p>Open Bootice, select your disk, click &quot;Process MBR&quot;, and choose &quot;Windows NT 5.x/6.x MBR&quot;. This replaces GRUB with the Windows MBR.</p>
<h3>Step 2: Rewrite PBR with Bootice</h3>
<p>In Bootice, select your Windows partition, click &quot;Process PBR&quot;, and choose &quot;BOOTMGR boot record&quot;. This ensures the PBR points to <code>bootmgr</code>.</p>
<h3>Step 3: Repair BCD with BCDrepair</h3>
<p>Run BCDrepair and let it automatically fix the BCD file. This ensures Windows knows where to find <code>winload.exe</code>.</p>
<h2>Summary</h2>
<p>The Windows boot chain has three critical components:</p>
<table>
<thead>
<tr>
<th>Component</th>
<th>Location</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td>MBR</td>
<td>First 512 bytes of disk</td>
<td>Find and load PBR</td>
</tr>
<tr>
<td>PBR</td>
<td>Start of system partition</td>
<td>Load bootmgr</td>
</tr>
<tr>
<td>BCD</td>
<td>\boot\bcd</td>
<td>Configure boot options</td>
</tr>
</tbody></table>
<p>When removing a Linux dual-boot, always restore the Windows MBR first, or use the Windows installation media&#39;s repair option to avoid these issues entirely.</p>

</div><div class="lang-zh">
<p>我最近在双启动 Windows 10 和 Linux。当我决定移除 Linux 时，我只是从 Windows PE 格式化了 Linux 分区。糟糕的决定。重启后，我看到了 <code>grub rescue&gt;</code>。是时候学习启动系统实际是如何工作的了。</p>
<h2>问题</h2>
<p>当你在 Windows 旁边安装 Linux 时，GRUB（Linux 引导程序）会接管 MBR。GRUB 将自身的一部分存储在 MBR 中，配置文件存储在 Linux 分区的 <code>/boot/grub/</code>。当你删除 Linux 分区时，你删除了 GRUB 的配置文件，但 GRUB 仍然在 MBR 中试图加载它们。</p>
<h2>理解启动过程</h2>
<h3>关键概念</h3>
<p><strong>MBR（主引导记录）</strong></p>
<p>硬盘的前 512 字节，包含：</p>
<ul>
<li><strong>引导加载程序</strong>（446 字节）：初始引导代码</li>
<li><strong>DPT - 磁盘分区表</strong>（64 字节）：分区信息（最多 4 个主分区）</li>
<li><strong>魔数</strong>（2 字节）：引导签名 <code>55 AA</code></li>
</ul>
<p><strong>PBR（分区引导记录）</strong></p>
<p>位于每个可引导分区的开头。包含加载操作系统引导程序（如 Windows 的 <code>bootmgr</code>）的代码。</p>
<p><strong>BCD（引导配置数据）</strong></p>
<p>Windows 引导配置文件，替代旧的 <code>boot.ini</code>。位于系统分区的 <code>\boot\bcd</code>。</p>
<h3>Windows 引导序列</h3>
<pre><code class="language-text">BIOS → MBR → PBR → bootmgr → BCD → winload.exe → Windows 内核</code></pre><h3>Linux 引导序列</h3>
<pre><code class="language-text">BIOS → MBR (GRUB Stage 1) → PBR → GRUB Stage 2 → grub.cfg → Linux 内核</code></pre><h3>GRUB 如何引导 Windows</h3>
<p>双启动时，GRUB 通过将控制权交给 <code>bootmgr</code> 来链式加载 Windows：</p>
<pre><code class="language-text">BIOS → MBR (GRUB) → PBR → bootmgr → BCD → Windows</code></pre><h2>尝试从 grub rescue 恢复</h2>
<p>首先，我尝试从 <code>grub rescue&gt;</code> 提示符恢复：</p>
<pre><code class="language-bash"># 列出所有分区
ls
# 输出: (hd0)(hd0,msdos1)(hd1)(hd1,msdos3)(hd1,msdos2)(hd1,msdos1)

# 查找包含 GRUB 文件的分区
ls (hd0,msdos1)/boot/grub
ls (hd1,msdos1)/boot/grub
# 寻找不返回 &quot;error:unknown filesystem&quot; 的分区

# 如果找到，设置 root 并引导
set root=(hd1,msdos1)/boot/grub
set prefix=(hd1,msdos1)/boot/grub
insmod normal
normal</code></pre><p>这对我不起作用——所有分区都返回 <code>error:unknown filesystem</code>，因为 Linux 分区已经不存在了。</p>
<h2>解决方案：重建引导链</h2>
<p>我启动进入 Windows PE 并使用这些工具（通常包含在 PE 环境中）：</p>
<ul>
<li><strong>DiskGenius</strong>：重建 MBR</li>
<li><strong>BCDrepair</strong>：修复 BCD 文件</li>
<li><strong>Bootice</strong>：重建 MBR、PBR，编辑 BCD</li>
<li><strong>NTBoot</strong>：自动引导修复</li>
</ul>
<h3>步骤 1：使用 Bootice 重写 MBR</h3>
<p>打开 Bootice，选择你的磁盘，点击 &quot;Process MBR&quot;，选择 &quot;Windows NT 5.x/6.x MBR&quot;。这会用 Windows MBR 替换 GRUB。</p>
<h3>步骤 2：使用 Bootice 重写 PBR</h3>
<p>在 Bootice 中，选择你的 Windows 分区，点击 &quot;Process PBR&quot;，选择 &quot;BOOTMGR boot record&quot;。这确保 PBR 指向 <code>bootmgr</code>。</p>
<h3>步骤 3：使用 BCDrepair 修复 BCD</h3>
<p>运行 BCDrepair 让它自动修复 BCD 文件。这确保 Windows 知道在哪里找到 <code>winload.exe</code>。</p>
<h2>总结</h2>
<p>Windows 引导链有三个关键组件：</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>位置</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>MBR</td>
<td>磁盘前 512 字节</td>
<td>查找并加载 PBR</td>
</tr>
<tr>
<td>PBR</td>
<td>系统分区开头</td>
<td>加载 bootmgr</td>
</tr>
<tr>
<td>BCD</td>
<td>\boot\bcd</td>
<td>配置引导选项</td>
</tr>
</tbody></table>
<p>移除 Linux 双启动时，始终先恢复 Windows MBR，或使用 Windows 安装介质的修复选项来完全避免这些问题。</p>

</div>
      </div>
    </article>

    <footer class="site-footer">
      <p>&copy; 2026 Shiqi Mei</p>
    </footer>
  </div>
  <script type="module" src="../js/highlight.js"></script>
  <script src="../js/lang-toggle.js"></script>
</body>
</html>
